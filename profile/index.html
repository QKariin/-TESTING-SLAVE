<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no" />
  <title>The Altar</title>
  
  <script type="module" src="../js/main.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/dompurify@3.0.6/dist/purify.min.js"></script>

  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link href="https://fonts.googleapis.com/css2?family=Cinzel:wght@400;700;900&family=Inter:wght@200;300;400&family=Orbitron:wght@400;600&family=Italianno&display=swap" rel="stylesheet" />

  <link rel="stylesheet" href="../css/profile.css">
  <link rel="stylesheet" href="../css/reward.css">
</head>
<body>

<!-- SOUNDS -->
<audio id="msgSound" src="https://assets.mixkit.co/active_storage/sfx/2354/2354-preview.mp3"></audio>
<audio id="coinSound" src="/audio/2019-preview1.mp3"></audio>
<audio id="skipSound" src="https://static.wixstatic.com/mp3/ce3e5b_3b5b34d4083847e2b123b6fd9a8551fd.mp3"></audio>
<audio id="sfx-buy" src="/audio/2019-preview1.mp3"></audio>
<audio id="sfx-deny" src="https://assets.mixkit.co/active_storage/sfx/2578/2578-preview.mp3"></audio>

<!-- HIDDEN INPUTS (Logic) -->
<input type="file" id="profileUploadInput" accept="image/*" class="hidden" onchange="handleProfileUpload(this)">
<input type="file" id="evidenceInput" accept="image/*,video/*" class="hidden" onchange="handleEvidenceUpload(this)">
<input type="file" id="adminMediaInput" accept="image/*,video/*" class="hidden" onchange="handleAdminUpload(this)">

<!-- CELEBRATION OVERLAY -->
<div id="celebrationOverlay" style="position:fixed;inset:0;pointer-events:none;z-index:9999;display:flex;align-items:center;justify-content:center;opacity:0;transition:opacity 0.3s;">
    <div class="glass-card" style="border: 1px solid var(--gold); text-align:center; background: #000;">
        <div style="font-family:'Cinzel'; font-size:2rem; color:var(--gold);">OFFERING ACCEPTED</div>
    </div>
</div>

<!-- THE ALTAR CONTAINER -->
<div class="altar-layout">

    <!-- 1. THE PRESENCE (Background) -->
    <div class="queen-presence">
        <div class="queen-overlay"></div>
    </div>

    <!-- 2. THE SKY (Task) -->
    <!-- Logic ID: taskCard -->
    <div id="taskCard" class="altar-sky">
        <div id="activeBadge" class="hidden"></div>
        
        <div class="sky-line">
            <!-- Logic ID: timerDisplay -->
            <div id="timerDisplay" class="sky-timer">00:00:00</div>
            <!-- Logic ID: taskContent -->
            <div id="taskContent" class="sky-text">
                <h2 id="readyText">AWAITING ORDERS</h2>
            </div>
            <!-- Logic ID: mainButtonsArea -->
            <div id="mainButtonsArea">
                <button id="newTaskBtn" onclick="getRandomTask()" class="sky-btn">REQUEST</button>
            </div>
            
            <div id="cooldownSection" class="hidden" style="display:flex; gap:10px;">
                <button onclick="document.getElementById('evidenceInput').click()" class="sky-btn">UPLOAD</button>
                <button id="btnSkip" onclick="cancelPendingTask()" class="sky-btn-dim">SKIP</button>
            </div>
        </div>
    </div>

    <!-- 3. THE VOID (Center Content) -->
    <div class="altar-void">
        
        <!-- HOME VIEW -->
        <div id="viewServingTop" class="void-content">
            <!-- Logic ID: chatCard -->
            <div id="chatCard" class="chat-container">
                <div id="chatBadge" class="hidden"></div>
                
                <!-- Chat Body -->
                <div id="chatBody" class="chat-body">
                    <!-- Overlays (Logic) -->
                    <div id="kneelRewardOverlay" class="hidden" style="position:absolute; inset:0; z-index:100; display:flex; justify-content:center; align-items:center; background:rgba(0,0,0,0.8);">
                        <button onclick="claimKneelReward('coins')" class="sky-btn">CLAIM COINS</button>
                    </div>
                    <div id="chatMediaOverlay" class="hidden" style="position:absolute; inset:0; z-index:200; display:flex; justify-content:center; align-items:center; background:#000;">
                        <div id="mediaOverlayClose" onclick="closeChatPreview()" style="position:absolute; top:20px; right:20px; color:white; font-size:2rem; cursor:pointer;">X</div>
                        <div id="chatMediaOverlayContent"></div>
                    </div>
                    <div id="tributeHuntOverlay" class="hidden" style="position:absolute; inset:0; z-index:150; background:rgba(0,0,0,0.95); padding:20px;">
                        <button onclick="toggleTributeHunt()" style="color:white; float:right;">CLOSE</button>
                        <div id="huntStoreGrid" class="store-grid"></div>
                        <textarea id="huntNote" class="hidden"></textarea>
                    </div>

                    <!-- Messages -->
                    <div id="chatContent" class="chat-stream"></div>
                </div>

                <!-- Input -->
                <div class="whisper-input">
                    <input type="text" id="chatMsgInput" placeholder="Whisper to her..." onkeypress="handleChatKey(event)">
                    <button id="tributeHuntBtn" onclick="toggleTributeHunt()">üéÅ</button>
                </div>
            </div>
        </div>

        <!-- OTHER VIEWS (Overlays) -->
        <div id="viewBuy" class="void-content hidden">
            <div class="section-title">OFFERINGS</div>
            <div class="store-grid">
                <div class="store-item"><div class="si-val">1K</div><button class="si-btn" onclick="buyRealCoins(1000)">‚Ç¨10.00</button></div>
                <div class="store-item"><div class="si-val">5.5K</div><button class="si-btn" onclick="buyRealCoins(5500)">‚Ç¨50.00</button></div>
                <div class="store-item"><div class="si-val">12K</div><button class="si-btn" onclick="buyRealCoins(12000)">‚Ç¨100.00</button></div>
                <div class="store-item"><div class="si-val">30K</div><button class="si-btn" onclick="buyRealCoins(30000)">‚Ç¨250.00</button></div>
                <div class="store-item"><div class="si-val">70K</div><button class="si-btn" onclick="buyRealCoins(70000)">‚Ç¨500.00</button></div>
                <div class="store-item"><div class="si-val">150K</div><button class="si-btn" onclick="buyRealCoins(150000)">‚Ç¨1000.00</button></div>
            </div>
        </div>

        <div id="viewNews" class="void-content hidden">
            <div class="section-title">HER IMAGE</div>
            <div id="newsGrid" class="gallery-grid"></div>
        </div>

        <div id="viewVault" class="void-content hidden">
            <div class="section-title">YOUR VAULT</div>
            <div id="vaultGrid" class="gallery-grid"></div>
        </div>

        <div id="viewProtocol" class="void-content hidden">
            <div class="section-title">THE LAW</div>
            <div style="text-align:center; color:#888;">Submission is the only path.</div>
        </div>

        <!-- Hidden Logic Placeholders -->
        <div id="viewRewards" class="hidden"></div>
        <div id="viewHierarchy" class="hidden"></div>
        <div id="viewSession" class="hidden"></div>
        <div id="pendingSection" class="hidden"></div>
        <div id="historySection" class="hidden"></div>

    </div>

    <!-- 4. THE ANCHOR (Identity & Nav) -->
    <div class="altar-anchor">
        
        <!-- Navigation -->
        <div class="anchor-nav">
            <span class="nav-word" onclick="switchTab('serve')">ALTAR</span>
            <span class="nav-word" onclick="switchTab('news')">IMAGE</span>
            <span class="nav-word" onclick="switchTab('vault')">VAULT</span>
            <span class="nav-word" onclick="switchTab('buy')">OFFER</span>
            <span class="nav-word" onclick="switchTab('protocol')">LAW</span>
        </div>

        <!-- Identity -->
        <div class="anchor-identity">
            <div class="anchor-stats">
                <span id="points">0</span> MERIT
                <span class="sep">|</span>
                <span id="coins">0</span> CAPITAL
            </div>
            
            <div class="anchor-center">
                <div class="anchor-avatar" onclick="document.getElementById('profileUploadInput').click()">
                    <img id="profilePic" src="">
                </div>
                <div id="subName" class="anchor-name">SLAVE</div>
                <!-- Logic ID: btn / fill -->
                <div id="btn" class="anchor-kneel" 
                     onmousedown="handleHoldStart(event)" 
                     onmouseup="handleHoldEnd(event)" 
                     onmouseleave="handleHoldEnd(event)" 
                     ontouchstart="handleHoldStart(event)" 
                     ontouchend="handleHoldEnd(event)">
                    <div id="fill" class="kneel-fill"></div>
                    <span>KNEEL</span>
                </div>
            </div>

            <div id="subHierarchy" class="anchor-rank">LOADING...</div>
        </div>
    </div>

</div>

<!-- JAILED THEATER MODAL -->
<div id="glassModal" class="glass-modal" onclick="closeModal(event)">
    <div id="modalMediaContainer" class="modal-bg-photo"></div>
    <div id="modalGlassOverlay" class="modal-glass-overlay">
        <div id="modalCloseX" onclick="closeModal(null)">√ó</div>
        <div class="theater-content">
            <div id="modalInfoView" class="sub-view">
                <div class="stamp-container"><img id="modalStatusSticker" src="" class="m-status-sticker-lg"></div>
                <div class="reward-container"><div id="modalPoints" class="m-points-lg">+0 PTS</div><div id="modalSticker"></div></div>
            </div>
            <div id="modalFeedbackView" class="sub-view hidden">
                <h3 class="view-label">QUEEN'S FEEDBACK</h3>
                <div id="modalFeedbackMedia" class="fb-media-theater"></div>
                <div id="modalFeedbackText" class="theater-text-box"></div>
            </div>
            <div id="modalTaskView" class="sub-view hidden">
                <h3 class="view-label">THE ASSIGNMENT</h3>
                <div id="modalOrderText" class="theater-text-box"></div>
            </div>
        </div>
        <div class="modal-footer-menu">
            <button onclick="toggleHistoryView('feedback')" class="history-action-btn">FEEDBACK</button>
            <button onclick="toggleHistoryView('task')" class="history-action-btn">THE TASK</button>
            <button onclick="event.stopPropagation(); toggleHistoryView('proof')" class="history-action-btn">SEE PROOF</button>
            <button onclick="toggleHistoryView('info')" class="history-action-btn">STATUS</button>
            <button onclick="closeModal(null)" class="history-action-btn btn-close-red" style="grid-column: span 2;">CLOSE</button>
        </div>
    </div>
</div>

<script>
    document.querySelectorAll("[data-include]").forEach(async el => {
        const file = el.getAttribute("data-include");
        try { const html = await fetch(file).then(r => r.text()); el.innerHTML = html; } catch (err) {}
    });

    window.switchTab = function(viewId) {
        // Simple visual toggle + Logic Trigger
        const views = ['viewServingTop', 'viewProtocol', 'viewNews', 'viewVault', 'viewBuy'];
        views.forEach(id => document.getElementById(id).classList.add('hidden'));

        let targetId = viewId;
        if(viewId === 'serve') targetId = 'viewServingTop';
        if(viewId === 'news') targetId = 'viewNews';
        if(viewId === 'buy') targetId = 'viewBuy';
        if(viewId === 'vault') targetId = 'viewVault';
        if(viewId === 'protocol') targetId = 'viewProtocol';

        document.getElementById(targetId).classList.remove('hidden');

        if(typeof window.showView === 'function') window.showView(targetId);
    }
</script>

</body>
</html>
