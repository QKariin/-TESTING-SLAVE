<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Protocol Sanctuary</title>
    <!-- Fonts -->
    <link href="https://fonts.googleapis.com/css2?family=Cinzel:wght@400;700&family=Inter:wght@200;300;400&family=Orbitron:wght@400;600;900&family=Rajdhani:wght@500&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="console.css"> <!-- New CSS -->
    <!-- KEEP REWARD CSS FOR POPUPS -->
    <link rel="stylesheet" href="../css/reward.css"> 
    <script type="module" src="../js/main.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/dompurify@3.0.6/dist/purify.min.js"></script>
</head>
<body>

    <!-- 1. AUDIO ENGINE (Must be present for logic) -->
    <audio id="msgSound" src="https://assets.mixkit.co/active_storage/sfx/2354/2354-preview.mp3"></audio>
    <audio id="coinSound" src="/audio/2019-preview1.mp3"></audio>
    <audio id="skipSound" src="https://static.wixstatic.com/mp3/ce3e5b_3b5b34d4083847e2b123b6fd9a8551fd.mp3"></audio>
    <audio id="sfx-buy" src="/audio/2019-preview1.mp3"></audio>
    <audio id="sfx-deny" src="https://assets.mixkit.co/active_storage/sfx/2578/2578-preview.mp3"></audio>

    <!-- 2. HIDDEN INPUTS FOR LOGIC (Must exist for main.js to find them) -->
    <input type="file" id="profileUploadInput" accept="image/*" class="hidden" onchange="handleProfileUpload(this)">
    <input type="file" id="evidenceInput" accept="image/*,video/*" class="hidden" onchange="handleEvidenceUpload(this)">
    <input type="file" id="adminMediaInput" accept="image/*,video/*" class="hidden" onchange="handleAdminUpload(this)">

    <!-- 3. MAIN HUD LAYOUT -->
    <div class="hud-container">
        
        <!-- LEFT PILLAR: IDENTITY & STATS -->
        <div class="pillar-identity">
            
            <div class="identity-core">
                <!-- Avatar & Kneel Ring -->
                <div class="kneel-ring-container" onclick="document.getElementById('profileUploadInput').click()">
                    <!-- Using SVG for future ring logic if needed -->
                    <svg class="progress-ring" width="120" height="120" style="position: absolute; top:-10px; left:-10px;">
                        <circle class="progress-ring__circle" stroke="var(--gold)" stroke-width="1" fill="transparent" r="58" cx="60" cy="60"/>
                    </svg>
                    <!-- ID: profilePic (Logic requirement) -->
                    <img id="profilePic" src="" class="avatar-img">
                </div>
                <!-- ID: subName (Logic requirement) -->
                <div id="subName" class="identity-name">SLAVE</div>
            </div>

            <!-- ID: subHierarchy (Logic requirement) -->
            <div id="subHierarchy" class="rank-watermark">LOADING...</div>

            <!-- Stats Baseline -->
            <div class="stats-baseline">
                <div class="stat-unit">
                    <span class="stat-label">MERIT</span>
                    <!-- ID: points (Logic requirement) -->
                    <span id="points" class="stat-value">0</span>
                </div>
                <div class="stat-separator"></div>
                <div class="stat-unit">
                    <span class="stat-label">CAPITAL</span>
                    <!-- ID: coins (Logic requirement) -->
                    <span id="coins" class="stat-value">0</span>
                </div>
            </div>

            <!-- Stealth Navigation -->
            <div class="stealth-nav">
                <div class="nav-item active" onclick="switchTab('serve')">CONSOLE</div>
                <div class="nav-item" onclick="switchTab('news')">GALLERY</div>
                <div class="nav-item" onclick="switchTab('vault')">VAULT</div>
                <div class="nav-item" onclick="switchTab('buy')">STORE</div>
                <div class="nav-item" onclick="switchTab('protocol')">PROTOCOL</div>
            </div>
        </div>

        <!-- RIGHT STAGE: DYNAMIC CONTENT -->
        <div class="stage-directive">
            
            <!-- VIEW 1: HOME (SERVE) -->
            <div id="viewServingTop" class="view-container">
                
                <!-- A. HORIZON TASK BAR -->
                <!-- ID: taskCard (Logic uses this ID to find children) -->
                <div id="taskCard" class="horizon-task-bar">
                    
                    <!-- ID: timerDisplay (Logic requirement) -->
                    <div id="timerDisplay" class="task-timer">00:00:00</div>
                    
                    <!-- ID: taskContent (Logic injects HTML here) -->
                    <div id="taskContent" class="task-data">
                        <span class="task-label">CURRENT DIRECTIVE:</span>
                        <!-- ID: readyText (Logic requirement) -->
                        <h2 id="readyText" class="task-desc">AWAITING ORDERS</h2>
                    </div>

                    <!-- Action Area -->
                    <div id="mainButtonsArea">
                        <!-- ID: newTaskBtn (Logic requirement) -->
                        <button id="newTaskBtn" onclick="getRandomTask()" class="task-action-btn">[ REQUEST TASK ]</button>
                    </div>

                    <!-- Hidden Cooldown Section (Logic toggles this) -->
                    <div id="cooldownSection" class="hidden" style="display: flex; gap: 10px;">
                        <button onclick="document.getElementById('evidenceInput').click()" class="task-action-btn">[ UPLOAD ]</button>
                        <button id="btnSkip" onclick="cancelPendingTask()" class="task-action-btn" style="border-color: #333; color: #666;">SKIP</button>
                    </div>
                    
                    <!-- Stub for badge logic to prevent crash -->
                    <div id="activeBadge" class="hidden"></div> 
                </div>

                <!-- B. COMMUNICATION VOID -->
                <div class="comm-void">
                    <!-- ID: chatContent (Logic injects messages here) -->
                    <div id="chatContent" class="chat-stream"></div>

                    <!-- Input Horizon -->
                    <div class="input-horizon">
                        <!-- ID: chatMsgInput (Logic requirement) -->
                        <input type="text" id="chatMsgInput" placeholder="Speak, slave..." class="void-input" onkeypress="handleChatKey(event)">
                        <button class="void-send" onclick="sendChatMessage()">→</button>
                        <!-- Admin Upload Button (Hidden but accessible) -->
                        <button onclick="document.getElementById('adminMediaInput').click()" style="opacity:0; width:10px;">.</button>
                    </div>
                </div>
            </div>

            <!-- VIEW 2: STORE -->
            <div id="viewBuy" class="view-container hidden">
                <div class="horizon-task-bar">
                    <div class="task-timer" style="font-size: 1.5rem;">STORE</div>
                    <div class="task-data"><span class="task-desc">ACQUIRE CAPITAL</span></div>
                </div>
                <div class="store-grid">
                    <!-- Logic: buyRealCoins() -->
                    <div class="store-item"><div style="font-size:2rem; color:var(--gold);">1K</div><button class="si-btn" onclick="buyRealCoins(1000)">€10.00</button></div>
                    <div class="store-item"><div style="font-size:2rem; color:var(--gold);">5.5K</div><button class="si-btn" onclick="buyRealCoins(5500)">€50.00</button></div>
                    <div class="store-item"><div style="font-size:2rem; color:var(--gold);">12K</div><button class="si-btn" onclick="buyRealCoins(12000)">€100.00</button></div>
                    <div class="store-item"><div style="font-size:2rem; color:var(--gold);">30K</div><button class="si-btn" onclick="buyRealCoins(30000)">€250.00</button></div>
                    <div class="store-item"><div style="font-size:2rem; color:var(--gold);">70K</div><button class="si-btn" onclick="buyRealCoins(70000)">€500.00</button></div>
                    <div class="store-item"><div style="font-size:2rem; color:var(--gold);">150K</div><button class="si-btn" onclick="buyRealCoins(150000)">€1000.00</button></div>
                </div>
            </div>

            <!-- VIEW 3: GALLERY -->
            <div id="viewNews" class="view-container hidden">
                <div class="horizon-task-bar">
                    <div class="task-timer" style="font-size: 1.5rem;">GALLERY</div>
                    <div class="task-data"><span class="task-desc">THE QUEEN'S IMAGE</span></div>
                </div>
                <!-- ID: newsGrid (Logic populates this) -->
                <div id="newsGrid" class="gallery-grid"></div>
            </div>

            <!-- VIEW 4: VAULT -->
            <div id="viewVault" class="view-container hidden">
                <div class="horizon-task-bar">
                    <div class="task-timer" style="font-size: 1.5rem;">VAULT</div>
                    <div class="task-data"><span class="task-desc">UNLOCKED ASSETS</span></div>
                </div>
                <!-- ID: vaultGrid (Logic populates this) -->
                <div id="vaultGrid" class="gallery-grid"></div>
            </div>

            <!-- VIEW 5: PROTOCOL -->
            <div id="viewProtocol" class="view-container hidden">
                <div class="horizon-task-bar">
                    <div class="task-timer" style="font-size: 1.5rem;">PROTOCOL</div>
                </div>
                <div style="padding: 40px; color: #888; font-family: 'Inter';">
                    <!-- Standard Protocol Text -->
                    <p>Obedience is the only currency.</p>
                </div>
            </div>

            <!-- HIDDEN PLACEHOLDERS (To satisfy JS errors if elements are missing) -->
            <div id="viewRewards" class="hidden"></div>
            <div id="viewHierarchy" class="hidden"></div>
            <div id="viewSession" class="hidden"></div>
            <div id="pendingSection" class="hidden"></div>
            <div id="historySection" class="hidden"></div> <!-- Logic looks for this -->

        </div>
    </div>

    <!-- OVERLAYS (Must exist for logic to work) -->
    <!-- 1. KNEEL REWARD -->
    <div id="kneelRewardOverlay" class="hidden" style="position: absolute; inset: 0; background: rgba(0,0,0,0.9); z-index: 100; display: flex; align-items: center; justify-content: center;">
        <div class="glass-card" style="text-align: center;">
            <h2 style="color: var(--gold);">DEVOTION RECOGNIZED</h2>
            <div style="display:flex; gap:20px; margin-top:20px;">
                <button onclick="claimKneelReward('coins')" class="si-btn">CLAIM COINS</button>
                <button onclick="claimKneelReward('points')" class="si-btn">CLAIM POINTS</button>
            </div>
        </div>
    </div>

    <!-- 2. CHAT MEDIA PREVIEW -->
    <div id="chatMediaOverlay" class="hidden" style="position: absolute; inset: 0; background: rgba(0,0,0,0.95); z-index: 200; display: flex; align-items: center; justify-content: center;">
        <div id="mediaOverlayClose" onclick="closeChatPreview()" style="position: absolute; top: 20px; right: 20px; color: white; font-size: 2rem; cursor: pointer;">X</div>
        <div id="chatMediaOverlayContent"></div>
    </div>

    <!-- 3. TRIBUTE HUNT -->
    <div id="tributeHuntOverlay" class="hidden" style="position: absolute; inset: 0; background: #000; z-index: 150;">
        <!-- Keeps tribute logic happy without breaking UI -->
        <button onclick="toggleTributeHunt()" style="position:absolute; top:20px; right:20px; color:white;">CLOSE</button>
        <div id="huntStoreGrid" style="margin-top: 50px;"></div>
    </div>

    <!-- SCRIPT: The Brain (Restored Logic) -->
    <script>
        // 1. Load Includes (Keep profile card working if needed internally)
        document.querySelectorAll("[data-include]").forEach(async el => {
            const file = el.getAttribute("data-include");
            try { const html = await fetch(file).then(r => r.text()); el.innerHTML = html; } catch (err) {}
        });

        // 2. SWITCH TAB LOGIC (Connecting Menu to Views)
        window.switchTab = function(viewId) {
            // A. Visuals (Nav Active State)
            document.querySelectorAll('.nav-item').forEach(item => {
                if(item.getAttribute('onclick').includes(viewId)) item.classList.add('active');
                else item.classList.remove('active');
            });

            // B. Hide All Views
            const views = ['viewServingTop', 'viewProtocol', 'viewNews', 'viewVault', 'viewBuy'];
            views.forEach(id => {
                const el = document.getElementById(id);
                if(el) el.classList.add('hidden');
            });

            // C. Show Target
            let targetId = viewId;
            if(viewId === 'serve') targetId = 'viewServingTop';
            if(viewId === 'news') targetId = 'viewNews';
            if(viewId === 'buy') targetId = 'viewBuy';
            if(viewId === 'vault') targetId = 'viewVault';
            if(viewId === 'protocol') targetId = 'viewProtocol';

            const target = document.getElementById(targetId);
            if(target) target.classList.remove('hidden');

            // D. Trigger Main JS Logic (CRITICAL)
            if(typeof window.showView === 'function') {
                window.showView(targetId);
            }
        }
    </script>

</body>
</html>
