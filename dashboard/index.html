<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no" />
    <title>Admin OS</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link
        href="https://fonts.googleapis.com/css2?family=Orbitron:wght@400;700;900&family=Rajdhani:wght@500;600;700&family=Share+Tech+Mono&display=swap"
        rel="stylesheet" />
    <link rel="stylesheet" href="../css/dashboard.css">
    <link rel="stylesheet" href="../css/dashboard-modals.css">
    <link rel="stylesheet" href="../css/dashboard-mobile.css">
    <script src="https://cdn.jsdelivr.net/npm/dompurify@3.0.6/dist/purify.min.js"></script>
</head>

<body>

    <!-- SOUNDS -->
    <audio id="msgSound" src="https://assets.mixkit.co/active_storage/sfx/2354/2354-preview.mp3"></audio>
    <audio id="sfx-notify" src="https://static.wixstatic.com/mp3/ce3e5b_31aab32ecdf542e6b6fd01ef272d75bc.mp3"></audio>

    <!-- CMS DATALIST FOR AUTOCOMPLETE -->
    <datalist id="cmsTasksList"></datalist>

    <!-- NEW HEADER BAR (MOBILE ONLY) -->
    <div class="mobile-app-header">DASHBOARD</div>

    <div class="layout">
        <div class="sidebar">
            <div class="sb-dash-btn" onclick="showHome()">DASHBOARD</div>
            <div style="text-align:center; padding:5px; border-bottom:1px solid #333;">
                <div style="font-size:0.5rem; color:#666;">TODAY'S ID</div>
                <div id="adminDailyCode"
                    style="color:var(--blue); font-weight:900; font-family:'Share Tech Mono'; font-size:1.1rem;">----
                </div>
            </div>
            <div class="sb-head">SUB LIST</div>
            <div id="userList" class="user-list"></div>
        </div>

        <div class="content">
            <div id="viewHome">
                <!-- TOP HEADER -->
                <div class="v-header">
                    <div class="v-header-left">
                        <div class="v-breadcrumb">Pages / Dashboard</div>
                        <div class="v-title">Dashboard</div>
                    </div>
                </div>

                <!-- TOP STATS BAR -->
                <div class="v-grid-stats">
                    <div class="v-stat-card glass-card">
                        <div class="vs-info">
                            <div class="vs-label">Today's Tributes</div>
                            <div class="vs-val" id="statTributes">0 <span class="vs-perc">+55%</span></div>
                        </div>
                        <div class="vs-icon blue-bg">üí∞</div>
                    </div>
                    <div class="v-stat-card glass-card">
                        <div class="vs-info">
                            <div class="vs-label">Active Slaves</div>
                            <div class="vs-val" id="statActive">0 <span class="vs-perc">+5%</span></div>
                        </div>
                        <div class="vs-icon blue-bg">üë§</div>
                    </div>
                    <div class="v-stat-card glass-card">
                        <div class="vs-info">
                            <div class="vs-label">Pending Reviews</div>
                            <div class="vs-val" id="statPending">0 <span class="vs-perc neg">-14%</span></div>
                        </div>
                        <div class="vs-icon blue-bg">üìù</div>
                    </div>
                    <div class="v-stat-card glass-card">
                        <div class="vs-info">
                            <div class="vs-label">Total Failures</div>
                            <div class="vs-val" id="statSkipped">0 <span class="vs-perc">+8%</span></div>
                        </div>
                        <div class="vs-icon blue-bg">‚ö†Ô∏è</div>
                    </div>
                </div>

                <!-- MAIN GRID -->
                <div class="v-grid-main">
                    <!-- HERO CARD (Span 2) -->
                    <div class="v-hero-card glass-card span-2"
                        style="background-image: linear-gradient(rgba(6, 11, 40, 0.8), rgba(6, 11, 40, 0.8)), url('file:///Users/liviacechova/.gemini/antigravity/brain/c1ab10d8-6b32-44f4-8a50-c5bf71c367d7/vision_ui_hero_bg_1770998249615.png');">
                        <div class="vh-content">
                            <div class="vh-title">Welcome back,<br>Queen Karin</div>
                            <div class="vh-sub">System dominance is at 98%.<br>Manage your subjects below.</div>
                        </div>
                        <div class="vh-footer">Tap to record ‚Üí</div>
                    </div>

                    <!-- CIRCULAR GAUGE (Span 1) -->
                    <div class="v-gauge-card glass-card span-1">
                        <div class="vg-header">
                            <div class="vg-title">Silence Protocol</div>
                            <div class="vg-sub">System Health</div>
                        </div>
                        <div class="vg-gauge-con">
                            <div class="vg-circle">
                                <div class="vg-val" id="pdPercentage">0%</div>
                                <div class="vg-label">of Goal</div>
                            </div>
                        </div>

                        <!-- PROTOCOL CONTROLS (RESTORED LOGIC) -->
                        <div class="vg-controls">
                            <div class="vgc-row">
                                <div class="vgc-input-group">
                                    <span class="vgc-label">GOAL</span>
                                    <input type="number" id="pdGoal" class="vgc-input" value="1000">
                                </div>
                                <div class="vgc-switch" onclick="toggleNewbieImmunity()">
                                    <div id="pdImmunity" class="vgc-checkbox checked">‚úï</div>
                                    <span>NEWBIE SAFE</span>
                                </div>
                            </div>
                            <div class="vgc-actions">
                                <button class="vgc-btn" onclick="openExclusionModal()"
                                    title="Exclusions">EXCLUDE</button>
                                <button class="vgc-btn pink" onclick="openBroadcastModal()">BROADCAST</button>
                            </div>
                        </div>

                        <div class="vg-stats">
                            <button id="pdBtn" onclick="toggleProtocol()" class="vg-action-btn">ENGAGE</button>
                        </div>

                        <!-- Hidden progress elements for JS compatibility -->
                        <div id="pdProgress" style="display:none;">
                            <div id="pdFill"></div>
                            <div id="pdText"></div>
                        </div>
                    </div>

                    <!-- BEST SUB (Span 1) -->
                    <div class="v-best-sub glass-card span-1">
                        <div class="vb-header">
                            <div class="vb-title">Top Subject</div>
                            <div class="vb-sub">Merit Leader</div>
                        </div>
                        <div class="vb-content">
                            <div class="vb-av-box glow-blue">
                                <img id="bestSubAvatar" src="https://via.placeholder.com/100" class="vb-av">
                            </div>
                            <div id="bestSubName" class="vb-name">Searching...</div>
                            <div id="bestSubValue" class="vb-val">0 PTS</div>
                        </div>
                    </div>

                    <!-- COMMUNITY KNEELING COUNTER (Span 2) -->
                    <div class="v-kneel-card glass-card span-2">
                        <div class="vk-header">
                            <div class="vk-title">Endurance Tracking</div>
                            <div class="vk-sub">Total Community Kneel</div>
                        </div>
                        <div class="vk-counter-box">
                            <div id="totalKneelMins" class="vk-val">0</div>
                            <div class="vk-unit">MINUTES</div>
                        </div>
                        <div class="vk-footer-stats">
                            <div class="vk-sub-stat">
                                <span class="vks-label">Sessions</span>
                                <span id="totalKneelSessions" class="vks-val">0</span>
                            </div>
                            <div class="vk-sub-stat">
                                <span class="vks-label">Active</span>
                                <span id="activeKneelers" class="vks-val">0</span>
                            </div>
                        </div>
                    </div>

                    <!-- OPERATIONS MONITOR (Span 2) -->
                    <div class="v-monitor-card glass-card span-2">
                        <div class="vm-header">Operations Monitor</div>
                        <div id="opsList" class="vm-body"></div>
                    </div>

                    <!-- INTEL FEED (Span 4) -->
                    <div class="v-feed-card glass-card span-4">
                        <div class="vf-header">Revenue & Intel Stream</div>
                        <div id="feedLog" class="vf-body feed-log"></div>
                    </div>
                </div>
            </div>

            <div id="viewProfile">
                <div class="qp-header">
                    <div class="qp-cover"></div>
                    <div class="qp-av-con"><img
                            src="https://static.wixstatic.com/media/ce3e5b_1bd27ba758ce465fa89a36d70a68f355~mv2.png"
                            class="qp-av"></div>
                    <div class="qp-name">QUEEN KARIN</div>
                    <div class="qp-status">SYSTEM ADMINISTRATOR</div>
                    <div class="qp-stats-row">
                        <div class="qp-stat">
                            <div class="qp-s-val" id="cntPosts">0</div>
                            <div class="qp-s-lbl">POSTS</div>
                        </div>
                        <div class="qp-stat">
                            <div class="qp-s-val" id="cntSubs">0</div>
                            <div class="qp-s-lbl">SUBJECTS</div>
                        </div>
                        <div class="qp-stat">
                            <div class="qp-s-val" id="cntStories">0</div>
                            <div class="qp-s-lbl">STORIES</div>
                        </div>
                    </div>
                </div>
                <div class="story-rail" id="storyRail">
                    <div class="story-ring story-add" onclick="openProfileUpload(true)">+</div>
                </div>
                <div class="qp-tabs">
                    <div class="qp-tab active" onclick="switchProfileTab('media')">GRID</div>
                    <div class="qp-tab" onclick="switchProfileTab('text')">WRITINGS</div>
                </div>
                <div id="profileMediaGrid" class="media-grid"></div>
                <div id="profileTextGrid" class="text-grid d-none"></div>
                <button class="upload-fab" onclick="openProfileUpload(false)">+</button>
            </div>

            <div id="viewUser">


                <div class="split">
                    <div class="chat-panel">
                        <div class="cp-head">ENCRYPTED FEED</div>

                        <!-- NEW: OPS/INTEL/RECORD TOP SECTION (30-35% of Left Panel) -->
                        <div class="admin-dash-top"
                            style="display:flex; flex-direction:column; height:35%; border-bottom:1px solid #333; background:#080808;">
                            <!-- TABS -->
                            <div class="ap-nav"
                                style="display:flex; border-bottom:1px solid #333; background:#0a0a0a; flex-shrink:0;">
                                <button class="ap-tab active" onclick="switchAdminTab('ops')"
                                    style="flex:1; padding:8px; background:transparent; border:none; color:#666; font-family:'Orbitron'; cursor:pointer; border-bottom:2px solid transparent; font-size:0.7rem;">OPS</button>
                                <button class="ap-tab" onclick="switchAdminTab('intel')"
                                    style="flex:1; padding:8px; background:transparent; border:none; color:#666; font-family:'Orbitron'; cursor:pointer; border-bottom:2px solid transparent; font-size:0.7rem;">INTEL</button>
                                <button class="ap-tab" onclick="switchAdminTab('record')"
                                    style="flex:1; padding:8px; background:transparent; border:none; color:#666; font-family:'Orbitron'; cursor:pointer; border-bottom:2px solid transparent; font-size:0.7rem;">RECORD</button>
                            </div>

                            <!-- VIEWS -->
                            <div class="ap-content" style="flex:1; overflow-y:auto; overflow-x:hidden;">
                                <!-- OPS VIEW -->
                                <div id="tabOps" class="ap-view active" style="padding:10px;">


                                    <!-- 1. STATUS CARD (Luxurious Gold) -->
                                    <div class="active-task-card gold-theme">
                                        <div class="at-header">
                                            <div class="at-label">CURRENT STATUS</div>
                                            <div id="dActiveStatus" class="at-status-text">UNPRODUCTIVE</div>
                                        </div>

                                        <!-- Active Task Content -->
                                        <div id="activeTaskContent">
                                            <div class="at-sub-label">ACTIVE DIRECTIVE</div>
                                            <div id="dActiveText" class="at-text">None</div>
                                            <div class="at-timer-row">
                                                <div class="at-timer-label">TIME REMAINING</div>
                                                <div id="dActiveTimer" class="at-timer-large">--:--</div>
                                            </div>
                                            <div class="at-actions">
                                                <button class="at-btn at-fail"
                                                    onclick="adminTaskAction(currId, 'skip')">CANCEL TASK</button>
                                            </div>
                                        </div>

                                        <!-- IDLE ACTIONS (Visible when UNPRODUCTIVE) -->
                                        <div id="idleActions" style="display:none; padding-top:10px;">
                                            <button class="at-btn at-send" onclick="adminTaskAction(null, 'send')">SEND
                                                NEW TASK</button>
                                        </div>
                                    </div>

                                    <!-- 2. SCHEDULE BUTTON -->
                                    <button class="schedule-btn" onclick="toggleTaskQueue()">SCHEDULE TASKS</button>

                                    <!-- 3. HIDDEN QUEUE -->
                                    <div id="taskQueueContainer" class="task-queue-box hidden" style="margin-top:10px;">
                                        <div class="sec-title clickable-title" onclick="openTaskGallery()"
                                            style="color:var(--blue);">TASK QUEUE</div>
                                        <div id="qListContainer" class="q-list-vertical" style="max-height:150px;">
                                        </div>
                                        <div class="q-input-row">
                                            <input type="text" id="qInput" class="q-input" placeholder="Add task..."
                                                list="cmsTasksList">
                                            <button class="q-add-btn" onclick="addQueueTask()">+</button>
                                        </div>
                                    </div>
                                </div>

                                <!-- INTEL VIEW -->
                                <div id="tabIntel" class="ap-view hidden" style="padding:10px;">
                                    <!-- Moved from OPS: Pending Reviews -->
                                    <div id="userQueueSec" style="display:none; flex-direction:column; gap:8px;"></div>
                                    <div class="sec-box">
                                        <div class="sec-title">ENDURANCE TELEMETRY</div>
                                        <div id="kneelStatsBox" class="telemetry-grid">
                                            <div class="t-stat"><span>TOTAL</span><strong id="dTotalKneel">0h</strong>
                                            </div>
                                            <div class="t-stat"><span>SESSION</span><strong id="dLastKneel">--</strong>
                                            </div>
                                        </div>
                                    </div>
                                    <div class="sec-box">
                                        <div class="sec-title" style="color:var(--pink);">DOSSIER</div>
                                        <div id="dossierGrid" class="dossier-grid"></div>
                                    </div>
                                    <div class="sec-box">
                                        <div class="sec-title" style="color:var(--gold);">TRIBUTE INVENTORY</div>
                                        <div id="inventoryGrid" class="inv-grid"></div>
                                    </div>
                                </div>

                                <!-- RECORD VIEW -->
                                <div id="tabRecord" class="ap-view hidden" style="padding:10px;">
                                    <div class="sec-box">
                                        <div class="sec-title" style="color:var(--gold);">THE ALTAR</div>
                                        <div class="altar-admin-row">
                                            <div class="aa-slot" id="adminAltar1" onclick="manageAltar(1)">I</div>
                                            <div class="aa-slot" id="adminAltar2" onclick="manageAltar(2)">II</div>
                                            <div class="aa-slot" id="adminAltar3" onclick="manageAltar(3)">III</div>
                                        </div>
                                    </div>
                                    <div class="sec-box">
                                        <div class="sec-title">HONORS</div>
                                        <div id="userStickerCase" class="trophy-case-admin"></div>
                                    </div>
                                    <div class="sec-title">ARCHIVE</div>
                                    <div id="userHistoryGrid" class="history-grid"></div>
                                    <button id="loadMoreHist" class="load-more-btn" onclick="loadMoreHist()">LOAD
                                        MORE</button>
                                </div>
                            </div>
                        </div>
                        <!--Show media in chat -->
                        <div id="chatMediaOverlay" class="hidden" style="position: absolute; inset: 0; background: rgba(0,0,0,0.92);
                                z-index: 500; backdrop-filter: blur(20px);
                                display: flex; align-items: center; justify-content: center;">

                            <!-- Close button -->
                            <div id="mediaOverlayClose" onclick="closeChatPreview()" style="position:absolute; top:20px; right:20px; cursor:pointer;
                                    font-size:2rem; color:white; font-weight:300;">
                                &times;
                            </div>
                            <div id="chatMediaOverlayContent" style="width: 100%; max-width: 90%; max-height: 90%;
                                    display:flex; align-items:center; justify-content:center;">
                            </div>
                        </div>
                        <div class="c-body" id="adminChatBox"></div>
                        <!-- HIERARCHY STAMP -->
                        <div class="hierarchy-top" id="mirrorRank">SLAVE</div>
                        <div id="lastSeen"
                            style="text-align:center; font-family:'Rajdhani'; font-size:0.7rem; color:#666; margin-top:-20px; margin-bottom:20px; letter-spacing:1px;">
                            OFFLINE</div>
                        <div class="c-foot">
                            <div id="plusMenu" class="d-none">
                                <label class="menu-btn" for="adminMediaInput">
                                    <svg viewBox="0 0 24 24">
                                        <path
                                            d="M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zm0 18c-4.41 0-8-3.59-8-8s3.59-8 8-8 8 3.59 8 8-3.59 8-8 8zm-1-13h2v6h-2zm0 8h2v2h-2z" />
                                    </svg>
                                    Photo/Video
                                </label>
                            </div>
                            <input type="file" id="adminMediaInput" accept="image/*,video/*" class="hidden-input"
                                onchange="handleAdminUpload(this)">
                            <button class="btn-plus"
                                onclick="document.getElementById('adminMediaInput').click()">+</button>
                            <input type="text" id="adminInp" class="inp" placeholder="Command..."
                                onkeypress="if(event.key==='Enter') sendMsg()">
                            <button onclick="sendMsg()" class="btn-send">></button>
                        </div>
                    </div>

                    <!-- NEW RIGHT PANEL: USER PROFILE MIRROR -->
                    <div class="action-panel"
                        style="background:#050505; display:flex; flex-direction:column; height:100%; overflow-y: auto; overflow-x: hidden;">

                        <!-- 1. PROFILE HEADER (FULL MIRROR) -->
                        <div id="apMirrorHeader" class="ap-mirror-header" style="padding:20px; text-align:center; border-bottom:1px solid #333; 
                                    background-image: linear-gradient(rgba(0, 0, 0, 0.7), rgba(0, 0, 0, 0.7)), url('https://static.wixstatic.com/media/ce3e5b_13b4c9faf6c5471ca7d292968d40feee~mv2.png');
                                    background-size: cover; background-position: center;">

                            <!-- HIERARCHY STAMP -->
                            <div id="dMirrorHierarchy" class="hierarchy-top"
                                style="margin: 0 auto 15px auto; display:inline-block;" title="Current Rank">LOADING...
                            </div>

                            <!-- AVATAR -->
                            <div class="avatar-container" style="width:120px; height:140px; margin:0 auto 15px;">
                                <img id="dProfilePic"
                                    src="https://static.wixstatic.com/media/ce3e5b_78da97e06a3848df84d0b00c9e6dcfdd~mv2.png">
                            </div>

                            <!-- NAME & STATUS -->
                            <div id="dMirrorName" class="identity-name" style="margin-bottom:5px; font-size:1.2rem;">
                                SLAVE</div>
                            <div id="dMirrorStatus"
                                style="font-family:'Orbitron'; color:#00ff00; font-size:0.7rem; letter-spacing:1px; margin-bottom:15px;">
                                ONLINE</div>

                            <!-- STATS ROW (Merit / Capital) -->
                            <div class="stats-stack-row" style="margin-bottom:15px;">
                                <div class="stat-item">
                                    <span class="stat-lbl">MERIT</span>
                                    <span id="dMirrorPoints" class="stat-val">0</span>
                                </div>
                                <div class="stat-divider"></div>
                                <div class="stat-item">
                                    <span class="stat-lbl">CAPITAL</span>
                                    <span id="dMirrorWallet" class="stat-val">0</span>
                                    <!-- Admin Control for Wallet -->
                                    <div style="display:flex; justify-content:center; gap:5px; margin-top:5px;">
                                        <button onclick="adjustWallet('sub')"
                                            style="background:#222; border:1px solid #444; color:var(--red); font-size:10px; cursor:pointer;">-</button>
                                        <button onclick="adjustWallet('add')"
                                            style="background:#222; border:1px solid #444; color:var(--green); font-size:10px; cursor:pointer;">+</button>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- 2. EXPANDABLE STATS & PROGRESS (ALWAYS VISIBLE FOR ADMIN) -->
                        <div class="ap-vitals-mirror" style="padding:15px; background:#080808; display:block;">

                            <!-- KNEEL BAR (Visual Only or Admin Trigger) -->
                            <div class="kneel-sidebar-wrapper" style="margin-bottom:15px;">
                                <div class="kneel-bar-graphic" style="cursor:default;">
                                    <div class="graphic-fill" style="width:0%;"></div> <!-- No fill logic yet -->
                                    <span class="graphic-text">KNEEL TIME: <span id="dMirrorKneel">0h</span></span>
                                    <!-- Admin Buttons Overlay -->
                                    <div
                                        style="position:absolute; right:5px; top:0; bottom:0; display:flex; align-items:center;">
                                        <button onclick="adjustKneel('add')"
                                            style="background:#222; border:1px solid #444; color:var(--green); font-size:10px; padding:2px 5px; cursor:pointer;">+1H</button>
                                    </div>
                                </div>
                            </div>

                            <!-- NEW SLAVE STATS DRAWER MIRROR -->
                            <!-- 1. WHO YOU ARE (Current) -->
                            <div
                                style="width:100%; text-align:center; padding-bottom:15px; border-bottom:1px solid #333; margin-bottom:15px;">
                                <div style="font-family:'Cinzel'; font-size:0.6rem; color:#666; letter-spacing:2px;">
                                    CURRENT CLASSIFICATION</div>
                                <div id="admin_CurrentRank"
                                    style="font-family:'Cinzel'; font-size:1.2rem; color:#fff; margin:5px 0; text-transform:uppercase;">
                                    LOADING...</div>
                                <div id="admin_CurrentBenefits"
                                    style="font-family:'Cinzel'; font-size:0.65rem; color:#888; font-style:italic; padding:0 10px; line-height:1.4;">
                                </div>
                            </div>

                            <!-- 2. THE GOAL (Next Rank) -->
                            <div style="width:100%; text-align:center; margin-bottom:15px;">
                                <div
                                    style="font-family:'Orbitron'; font-size:0.6rem; color:#c5a059; letter-spacing:2px;">
                                    WORKING ON PROMOTION TO</div>
                                <div id="admin_NextRank"
                                    style="font-family:'Orbitron'; font-size:1.4rem; color:#c5a059; font-weight:900; letter-spacing:1px; margin-top:5px; text-shadow:0 0 15px rgba(197, 160, 89, 0.3); text-transform:uppercase;">
                                    LOADING...
                                </div>
                            </div>

                            <!-- 3. THE MATH (Progress Bars) -->
                            <div id="admin_ProgressContainer"
                                style="width:100%; background:rgba(255,255,255,0.02); border:1px solid #333; border-radius:4px; padding:15px; margin-bottom:20px;">
                                <!-- Bars Injected via JS -->
                            </div>

                            <!-- 4. THE PRIZE (Next Benefits) -->
                            <div style="width:100%; text-align:left; padding:0 5px; margin-bottom:15px;">
                                <div
                                    style="font-family:'Orbitron'; font-size:0.6rem; color:#c5a059; margin-bottom:8px;">
                                    PRIVILEGES GRANTED</div>
                                <ul id="admin_NextBenefits"
                                    style="color:#ccc; font-size:0.75rem; font-family:'Cinzel'; padding-left:20px; line-height:1.6; margin:0;">
                                    <!-- List Items via JS -->
                                </ul>
                            </div>

                            <!-- Routine (Preserved) -->
                            <div class="stat-line"><span>Routine</span> <strong id="dMirrorRoutine">PENDING</strong>
                            </div>

                            <!-- FOOTER -->
                            <div class="stat-footer">
                                <div style="color:#666; font-size:0.7rem; letter-spacing:2px; margin-bottom:5px;">SLAVE
                                    SINCE</div>
                                <strong id="dMirrorSlaveSince" style="color:#ccc; font-size:0.9rem;">--/--/--</strong>
                            </div>
                        </div>

                        <!-- GRID CARDS REMOVED (Redundant with Drawer) -->
                    </div>


                </div>
            </div>
        </div>
    </div>
    </div>

    <!-- MODALS -->
    <div id="reviewModal" class="modal" onclick="if(event.target === this) closeModal()">
        <div class="m-content" style="position: relative;">
            <!-- NEW: THE X CLOSE BUTTON -->
            <span onclick="closeModal()"
                style="position: absolute; top: 15px; right: 20px; font-size: 2.5rem; color: #666; cursor: pointer; z-index: 1100; line-height: 1; transition: 0.2s;"
                onmouseover="this.style.color='var(--pink)'" onmouseout="this.style.color='#666'">&times;</span>

            <div id="mMediaBox" class="m-media-box"></div>
            <div class="m-info">
                <div id="reviewNormalContent">
                    <div id="mText" class="m-text-scroll"></div>
                    <div id="modalActions"></div>
                </div>
                <div id="reviewRewardOverlay">
                    <h3 style="color:var(--green); margin-bottom:15px; text-align:center;">REWARD PROTOCOL</h3>
                    <div id="stickerGrid" class="sticker-grid"></div>
                    <div class="reward-inputs">
                        <div class="rw-group">
                            <div class="rw-label">BONUS COINS</div>
                            <input type="number" id="rewardBonus" class="rw-inp" value="50">
                        </div>
                        <div class="rw-group">
                            <div class="rw-label">COMMENT</div>
                            <input type="text" id="rewardComment" class="rw-inp" placeholder="Optional message...">
                        </div>
                    </div>
                    <div class="rw-media-row">
                        <label for="rewardFileUpload" class="rw-icon-btn">
                            <svg viewBox="0 0 24 24">
                                <path
                                    d="M14,2H6A2,2 0 0,0 4,4V20A2,2 0 0,0 6,22H18A2,2 0 0,0 20,20V8L14,2M18,20H6V4H13V9H18V20Z" />
                            </svg>
                        </label>
                        <div id="btnRecordReward" class="rw-icon-btn" onclick="toggleRewardRecord()">
                            <svg viewBox="0 0 24 24">
                                <path
                                    d="M12,2A3,3 0 0,1 15,5V11A3,3 0 0,1 12,14A3,3 0 0,1 9,11V5A3,3 0 0,1 12,2M19,11C19,14.53 16.39,17.44 13,17.93V21H11V17.93C7.61,17.44 5,14.53 5,11H7A5,5 0 0,0 12,16A5,5 0 0,0 17,11H19Z" />
                            </svg>
                        </div>
                        <div id="rewardMediaPreview" class="rw-preview-box d-none"></div>
                    </div>
                    <input type="file" id="rewardFileUpload" accept="image/*,video/*,audio/*"
                        onchange="handleRewardFileUpload(this)" style="display:none;">
                    <div style="display:flex; gap:10px; margin-top:15px;">
                        <button onclick="cancelReward()"
                            style="flex:1; padding:10px; background:#666; color:white; border:none; border-radius:4px;">CANCEL</button>
                        <button onclick="confirmReward()"
                            style="flex:1; padding:10px; background:var(--green); color:black; border:none; border-radius:4px; font-weight:bold;">CONFIRM</button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <div id="exclusionModal" class="modal">
        <div class="m-content"
            style="width:400px; height:auto; max-height:70vh; display:flex; flex-direction:column; padding:20px;">
            <h3 style="color:var(--red); margin-bottom:15px; text-align:center;">PROTOCOL EXCLUSIONS</h3>
            <div id="exclusionList" class="ex-list"></div>
            <button onclick="closeExclusionModal()"
                style="margin-top:15px; padding:10px; background:#666; color:white; border:none; border-radius:4px;">CLOSE</button>
        </div>
    </div>

    <div id="broadcastModal" class="modal">
        <div class="m-content"
            style="display:flex; flex-direction:column; width:600px; height:auto; max-height:80vh; padding:20px; border:1px solid var(--pink); box-shadow:0 0 20px rgba(255,0,222,0.1);">
            <div class="br-head">BROADCAST MESSAGE</div>
            <textarea id="brText" class="br-inp" placeholder="Enter your message..."></textarea>
            <div class="br-preset-row">
                <button class="br-mini-btn" onclick="saveBroadcastPreset()">SAVE PRESET</button>
                <button class="br-mini-btn" onclick="togglePresets()">LOAD PRESET</button>
            </div>
            <div id="presetList"></div>
            <label for="brFile" class="br-file-label">
                <svg viewBox="0 0 24 24">
                    <path d="M14,2H6A2,2 0 0,0 4,4V20A2,2 0 0,0 6,22H18A2,2 0 0,0 20,20V8L14,2M18,20H6V4H13V9H18V20Z" />
                </svg>
                ATTACH MEDIA
            </label>
            <input type="file" id="brFile" accept="image/*,video/*" onchange="handleBroadcastFile(this)"
                style="display:none;">
            <img id="brPreviewImg" class="br-prev">
            <video id="brPreviewVid" class="br-prev" muted autoplay loop></video>
            <h4 style="color:var(--pink); margin:15px 0 10px 0; font-size:0.9rem;">EXCLUDE USERS:</h4>
            <div id="brUserList" class="ex-list" style="max-height:150px; overflow-y:auto;"></div>
            <div style="display:flex; gap:10px; margin-top:15px;">
                <button onclick="closeBroadcastModal()"
                    style="flex:1; padding:15px; background:#666; color:white; border:none; border-radius:4px;">CANCEL</button>
                <button onclick="sendBroadcast()" class="br-btn">SEND BROADCAST</button>
            </div>
        </div>
    </div>

    <!-- MODAL: COMMAND ARMORY WORKSHOP -->
    <div id="taskGalleryModal" class="modal">
        <div class="m-content"
            style="width:98%; max-width:1300px; height:92vh; display:flex; flex-direction:column; padding:0; border:1px solid var(--blue); background:rgba(5,5,5,0.98); border-radius:15px; overflow:hidden;">

            <!-- CENTERED STACKED HEADER -->
            <div
                style="padding:20px; border-bottom:1px solid #222; display:flex; flex-direction:column; align-items:center; gap:10px; background:rgba(0,0,0,0.8); flex-shrink:0; position:relative;">

                <!-- CLOSE BUTTON (Fixed to Right) -->
                <button onclick="closeTaskGallery()"
                    style="position:absolute; right:20px; top:15px; background:transparent; border:none; color:#444; font-size:2rem; cursor:pointer;">&times;</button>

                <!-- LINE 1: NAME -->
                <div id="armoryTitle"
                    style="color:white; font-weight:900; font-size:1.6rem; letter-spacing:4px; font-family:'Orbitron'; text-transform:uppercase;">
                    SLAVE TASKS</div>

                <!-- LINE 2: SMALL SEARCH -->
                <input type="text" id="taskSearchInput" onkeyup="filterTaskGallery()" placeholder="SEARCH DIRECTIVES..."
                    style="width:300px; background:#000; border:1px solid #333; border-radius:15px; padding:6px 15px; color:white; font-family:'Rajdhani'; font-size:0.75rem; outline:none; letter-spacing:1px; text-align:center; transition:0.3s;">
            </div>

            <!-- MAIN SPLIT AREA -->
            <div style="display:grid; grid-template-columns: 420px 1fr; flex:1; overflow:hidden;">
                <div
                    style="border-right:1px solid #222; background:rgba(0,0,0,0.3); display:flex; flex-direction:column; overflow:hidden;">
                    <div id="armoryLiveQueue"
                        style="flex:1; overflow-y:auto; padding:15px; display:flex; flex-direction:column; gap:8px;">
                    </div>
                </div>
                <div id="glassTaskGrid" style="flex:1; overflow-y:auto; padding:20px; background:#050505;"></div>
            </div>
        </div>
    </div>

    <!-- CUSTOM SLOT PICKER OVERLAY -->
    <div id="slotPickerModal" class="modal" style="z-index: 10001;">
        <div
            style="background: rgba(5,5,5,0.95); border: 1px solid var(--blue); padding: 30px; border-radius: 15px; text-align: center; box-shadow: 0 0 30px rgba(0,243,255,0.2);">
            <div
                style="font-family: 'Orbitron'; color: white; font-size: 0.9rem; letter-spacing: 3px; margin-bottom: 20px;">
                SELECT TARGET SLOT</div>
            <div id="slotGrid"
                style="display: grid; grid-template-columns: repeat(5, 1fr); gap: 10px; margin-bottom: 20px;">
                <!-- Numbers 1-10 injected here -->
            </div>
            <button onclick="document.getElementById('slotPickerModal').classList.remove('active')"
                style="background: transparent; border: 1px solid #444; color: #666; font-family: 'Rajdhani'; font-size: 0.7rem; padding: 5px 15px; cursor: pointer; border-radius: 4px;">CANCEL</button>
        </div>
    </div>

    <!-- JavaScript Modules -->
    <script type="module" src="../js/dashboard-main.js"></script>

</body>

</html>
